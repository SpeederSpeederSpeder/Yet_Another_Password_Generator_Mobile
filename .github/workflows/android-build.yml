name: Build Android APK (Bubblewrap)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Bubblewrap
        run: npm install -g @bubblewrap/cli

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Configure Bubblewrap
        run: |
          mkdir -p ~/.bubblewrap
          # On ubuntu-latest, ANDROID_HOME is usually /usr/local/lib/android/sdk
          # We explicitly set it to ensure Bubblewrap finds it
          SDK_PATH=${ANDROID_HOME:-/usr/local/lib/android/sdk}
          echo "{\"jdkPath\":\"$JAVA_HOME\",\"androidSdkPath\":\"$SDK_PATH\"}" > ~/.bubblewrap/config.json
          
          # Accept Android licenses
          yes | $SDK_PATH/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Build APK
        run: |
          # Generate a temporary keystore
          keytool -genkey -v -keystore android.keystore -alias android -keyalg RSA -keysize 2048 -validity 10000 -storepass password -keypass password -dname "CN=Kryptopass, OU=Mobile, O=Kryptopass, L=Paris, S=France, C=FR"
          
          # 1. Backup original manifest files
          cp twa-manifest.json twa-manifest.json.bak
          cp manifest.json manifest.json.bak

          # 2. Prepare local server directory structure to match production URL path
          mkdir -p Yet_Another_Password_Generator_Mobile
          cp manifest.json Krypto.png Yet_Another_Password_Generator_Mobile/
          
          # 3. Start a local server (bound explicitly to 127.0.0.1)
          python3 -m http.server 8080 --bind 127.0.0.1 &
          SERVER_PID=$!
          sleep 5 # Give the server time to start
          
          # 4. Prepare local manifest for generation
          # Use 127.0.0.1 instead of localhost to avoid IPv6 resolution issues
          jq '. + {"start_url": "http://127.0.0.1:8080/Yet_Another_Password_Generator_Mobile/", "iconUrl": "http://127.0.0.1:8080/Yet_Another_Password_Generator_Mobile/Krypto.png"}' manifest.json.bak > Yet_Another_Password_Generator_Mobile/manifest.json
          
          # 5. Temporarily point twa-manifest.json to local server
          sed -i 's|https://SpeederSpeederSpeder.github.io/Yet_Another_Password_Generator_Mobile/manifest.json|http://127.0.0.1:8080/Yet_Another_Password_Generator_Mobile/manifest.json|g' twa-manifest.json

          # 6. Run bubblewrap update
          # This generates/updates the Android project files
          VERSION_NAME=$(jq -r .appVersionName twa-manifest.json.bak)
          VERSION_CODE=$(jq -r .appVersionCode twa-manifest.json.bak)
          yes | bubblewrap update --appVersionName "$VERSION_NAME" --appVersionCode "$VERSION_CODE"
          
          # 7. Stop the local server
          kill $SERVER_PID
          
          # 8. Restore original manifest files and cleanup
          mv twa-manifest.json.bak twa-manifest.json
          mv manifest.json.bak manifest.json
          rm -rf Yet_Another_Password_Generator_Mobile

          # 9. Patch generated files to use real domain instead of 127.0.0.1
          # Target only the app directory and build files to avoid messing with config.json
          grep -rl "127.0.0.1:8080" ./app ./*.gradle | xargs -r sed -i 's|http://127.0.0.1:8080|https://SpeederSpeederSpeder.github.io|g'
          grep -rl "127.0.0.1" ./app ./*.gradle | xargs -r sed -i 's|127.0.0.1|SpeederSpeederSpeder.github.io|g'
          
          # Build the APK
          bubblewrap build --skipCheck --signingKeyPath android.keystore --signingKeyAlias android --signingKeyPassword password --signingStorePassword password

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: ./*.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: ./*.apk
